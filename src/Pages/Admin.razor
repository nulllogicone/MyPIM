@page "/admin"
@attribute [Authorize(Policy = "AdminGroup")]
@using MyPIM.Data
@using MyPIM.Services
@inject PimTableService TableService
@inject IGraphService GraphService
@inject IEventService EventService

<h3>Admin Dashboard</h3>

<ul class="nav nav-tabs mb-3">
    <li class="nav-item">
        <a class="nav-link @(activeTab == "approvals" ? "active" : "")" @onclick='() => activeTab = "approvals"' style="cursor:pointer">Approvals</a>
    </li>
    <li class="nav-item">
        <a class="nav-link @(activeTab == "config" ? "active" : "")" @onclick='() => activeTab = "config"' style="cursor:pointer">Configuration</a>
    </li>
    <AuthorizeView Policy="AdminGroup">
        <Authorized>
            <li class="nav-item">
                <a class="nav-link @(activeTab == "history" ? "active" : "")" @onclick='() => activeTab = "history"' style="cursor:pointer">History</a>
            </li>
        </Authorized>
        <NotAuthorized>
            <li class="nav-item">
                <a class="nav-link disabled" style="cursor:not-allowed" title="History requires MyPim security group membership">History</a>
            </li>
        </NotAuthorized>
    </AuthorizeView>
</ul>

@if (activeTab == "approvals")
{
        <h4>Pending Requests</h4>
        <table class="table">
            <thead>
                <tr>
                    <th>User</th>
                    <th>Role</th>
                    <th>Reason</th>
                    <th>Requested</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
            @foreach (var req in pendingRequests)
            {
                        <tr>
                            <td>@req.UserDisplayName</td>
                            <td>@req.RoleName</td>
                            <td>@req.Reason</td>
                            <td>@req.RequestedAt.ToString("g")</td>
                            <td>
                                <button class="btn btn-sm btn-success" @onclick="() => Approve(req)">Approve</button>
                                <button class="btn btn-sm btn-danger" @onclick="() => Deny(req)">Deny</button>
                            </td>
                        </tr>
            }
            </tbody>
        </table>
}
else if (activeTab == "config")
{
        <h4>Managed Roles</h4>
        <table class="table">
            <thead>
                <tr>
                    <th>Role Name</th>
                    <th>Duration (Min)</th>
                    <th>Enabled</th>
                </tr>
            </thead>
            <tbody>
            @foreach (var config in configs)
            {
                        <tr>
                            <td>@config.RoleName</td>
                            <td>@config.DefaultDurationMinutes</td>
                            <td>@config.IsEnabled</td>
                        </tr>
            }
            </tbody>
        </table>
        <div class="alert alert-info">
            Note: Configuration management is read-only in this mock demo.
        </div>
}
else if (activeTab == "history")
{
    <AuthorizeView Policy="AdminGroup">
        <Authorized>
            <h4>Request History</h4>
            <table class="table">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Role</th>
                        <th>Reason</th>
                        <th>Requested</th>
                        <th>Status</th>
                        <th>Processed</th>
                        <th>Expires/Expired</th>
                    </tr>
                </thead>
                <tbody>
                @foreach (var req in historyRequests)
                {
                            <tr>
                                <td>@req.UserDisplayName</td>
                                <td>@req.RoleName</td>
                                <td>@req.Reason</td>
                                <td>@req.RequestedAt.ToString("g")</td>
                                <td>
                                    @if (req.PartitionKey == RequestStatus.Active)
                                    {
                                                <span class="badge bg-success">Active</span>
                                    }
                                    else if (req.PartitionKey == RequestStatus.Rejected)
                                    {
                                                <span class="badge bg-danger">Rejected</span>
                                    }
                                    else if (req.PartitionKey == RequestStatus.Expired)
                                    {
                                                <span class="badge bg-secondary">Expired</span>
                                    }
                                    else if (req.PartitionKey == RequestStatus.Revoked)
                                    {
                                                <span class="badge bg-warning">Revoked</span>
                                    }
                                </td>
                                <td>@req.ApprovedAt?.ToString("g")</td>
                                <td>@req.ExpiresAt?.ToString("g")</td>
                            </tr>
                }
                </tbody>
            </table>
        </Authorized>
        <NotAuthorized>
            <div class="alert alert-warning">You do not have permission to view history. Membership in the MyPim security group is required.</div>
        </NotAuthorized>
    </AuthorizeView>
}

@code {
    private string activeTab = "approvals";
    private List<AccessRequest> pendingRequests = new();
    private List<AccessRequest> historyRequests = new();
    private List<PimRoleConfiguration> configs = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        pendingRequests = await TableService.GetRequestsByStatusAsync(RequestStatus.Pending);
        
        // Load history: Active, Rejected, Expired, Revoked
        var active = await TableService.GetRequestsByStatusAsync(RequestStatus.Active);
        var rejected = await TableService.GetRequestsByStatusAsync(RequestStatus.Rejected);
        var expired = await TableService.GetRequestsByStatusAsync(RequestStatus.Expired);
        var revoked = await TableService.GetRequestsByStatusAsync(RequestStatus.Revoked);
        
        historyRequests = active.Concat(rejected).Concat(expired).Concat(revoked)
            .OrderByDescending(r => r.ApprovedAt ?? r.RequestedAt)
            .ToList();

        configs = await TableService.GetConfigurationsAsync();

        // Mock Configs if empty (first run)
        if (!configs.Any())
        {
            var roles = await GraphService.GetAvailableDirectoryRolesAsync();
            foreach (var r in roles)
            {
                await TableService.SaveConfigurationAsync(r);
            }
            configs = await TableService.GetConfigurationsAsync();
        }
    }

    private async Task Approve(AccessRequest req)
    {
        // 1. Assign in Graph
        await GraphService.AssignRoleAsync(req.UserId, req.RoleId);

        // 2. Update Status and Expiry
        // Get duration from config
        var config = configs.FirstOrDefault(c => c.RowKey == req.RoleId);
        var duration = config?.DefaultDurationMinutes ?? 60;

        req.ExpiresAt = DateTimeOffset.UtcNow.AddMinutes(duration);
        req.ApprovedAt = DateTimeOffset.UtcNow; // Assume current user approved

        await TableService.UpdateRequestStatusAsync(req, RequestStatus.Active);
        await EventService.PublishRequestApprovedAsync(req);
        await LoadData();
    }

    private async Task Deny(AccessRequest req)
    {
        await TableService.UpdateRequestStatusAsync(req, RequestStatus.Rejected);
        await EventService.PublishRequestRejectedAsync(req);
        await LoadData();
    }
}
